# åŸ·è¡Œæ­·å²è¨˜éŒ„åŠŸèƒ½ - ä½¿ç”¨èªªæ˜

## ğŸ“Œ åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»çµ±å·²æˆåŠŸå¯¦ç¾å®Œæ•´çš„åŸ·è¡Œæ­·å²è¨˜éŒ„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- âœ… 8 å€‹ API ç«¯é»ï¼ˆå®Œæ•´æ”¯æ´éœ€æ±‚æ–‡ä»¶è¦æ ¼ï¼‰
- âœ… è³‡æ–™åº«è¡¨æ ¼ï¼ˆexecution_history å’Œ product_change_logï¼‰
- âœ… å¾Œå°ç®¡ç†ä»‹é¢
- âœ… å®Œæ•´çš„æ•¸æ“šçµ±è¨ˆå’ŒæŸ¥è©¢åŠŸèƒ½

---

## ğŸŒ å¾Œå°ç®¡ç†é é¢

### è¨ªå•åœ°å€

**åŸ·è¡Œæ­·å²åˆ—è¡¨é é¢**ï¼š
```
http://localhost:8080/admin/execution-history
```

**åŸ·è¡Œè©³æƒ…é é¢**ï¼š
```
http://localhost:8080/admin/execution-history/detail/{execution_id}
```

### åŠŸèƒ½ç‰¹è‰²

1. **åŸ·è¡Œæ­·å²åˆ—è¡¨**
   - åˆ†é é¡¯ç¤ºæ‰€æœ‰åŸ·è¡Œè¨˜éŒ„
   - ç¯©é¸åŠŸèƒ½ï¼šç‹€æ…‹ã€æ¨¡å¼ã€æ—¥æœŸç¯„åœ
   - å³æ™‚çµ±è¨ˆï¼šç¸½åŸ·è¡Œæ¬¡æ•¸ã€æˆåŠŸ/å¤±æ•—è¨ˆæ•¸
   - å¿«é€ŸæŸ¥çœ‹åŸ·è¡Œè©³æƒ…

2. **åŸ·è¡Œè©³æƒ…é é¢**
   - å®Œæ•´åŸ·è¡Œè³‡è¨Šï¼ˆåŸ·è¡Œ IDã€æ™‚é–“ã€ç‹€æ…‹ã€çµ±è¨ˆï¼‰
   - æ‰€æœ‰å•†å“è®Šæ›´è¨˜éŒ„
   - åƒ¹æ ¼å’Œå°ºå¯¸è®ŠåŒ–å°æ¯”é¡¯ç¤º
   - å‹•ä½œé¡å‹åˆ†é¡çµ±è¨ˆ

---

## ğŸ”Œ API ç«¯é»æ¸…å–®

æ‰€æœ‰ API ç«¯é»éƒ½éœ€è¦åœ¨ Header ä¸­åŒ…å« API Keyï¼š
```
X-API-Key: your-api-key-here
```

### 1. é–‹å§‹åŸ·è¡Œè¨˜éŒ„
```
POST http://localhost:8080/api/v1/shoes/execution/start
```

**è«‹æ±‚ç¯„ä¾‹**ï¼š
```json
{
    "total_products": 528,
    "mode": "production"
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
    "success": true,
    "data": {
        "execution_id": "550e8400-e29b-41d4-a716-446655440000",
        "start_time": "2026-02-10T21:30:00+08:00"
    },
    "message": "åŸ·è¡Œè¨˜éŒ„å·²å‰µå»º"
}
```

---

### 2. è¨˜éŒ„å–®å€‹å•†å“è®Šæ›´
```
POST http://localhost:8080/api/v1/shoes/execution/log
```

**è«‹æ±‚ç¯„ä¾‹**ï¼š
```json
{
    "execution_id": "550e8400-e29b-41d4-a716-446655440000",
    "product_code": "1103a128-100",
    "product_name": "DSãƒ©ã‚¤ãƒˆ ã‚¯ãƒ©ãƒ– ãƒ›ãƒ¯ã‚¤ãƒˆÃ—ã‚¢ã‚·ãƒƒã‚¯ã‚¹ãƒ–ãƒ«ãƒ¼",
    "action_type": "update",
    "before_price": "7,480",
    "after_price": "6,980",
    "before_size": "24.0, 25.0, 26.0",
    "after_size": "24.0, 25.0, 26.0, 27.0",
    "change_reason": "åƒ¹æ ¼é™ä½ 500 æ—¥åœ“ï¼Œæ–°å¢ 27.0 å°ºç¢¼"
}
```

---

### 3. æ‰¹é‡è¨˜éŒ„è®Šæ›´
```
POST http://localhost:8080/api/v1/shoes/execution/log-batch
```

**è«‹æ±‚ç¯„ä¾‹**ï¼š
```json
{
    "execution_id": "550e8400-e29b-41d4-a716-446655440000",
    "changes": [
        {
            "product_code": "1103a128-100",
            "action_type": "update",
            "before_price": "7,480",
            "after_price": "6,980",
            "change_reason": "åƒ¹æ ¼é™ä½"
        },
        {
            "product_code": "1103a128-001",
            "action_type": "create",
            "after_price": "8,500",
            "after_size": "24.0, 25.0",
            "change_reason": "æ–°å•†å“"
        }
    ]
}
```

---

### 4. å®ŒæˆåŸ·è¡Œè¨˜éŒ„
```
POST http://localhost:8080/api/v1/shoes/execution/complete
```

**è«‹æ±‚ç¯„ä¾‹**ï¼š
```json
{
    "execution_id": "550e8400-e29b-41d4-a716-446655440000",
    "created_count": 50,
    "updated_count": 30,
    "skipped_count": 448,
    "failed_count": 0,
    "status": "success"
}
```

---

### 5. æŸ¥è©¢åŸ·è¡Œæ­·å²åˆ—è¡¨
```
GET http://localhost:8080/api/v1/shoes/execution/history?page=1&page_size=20&status=success
```

**æŸ¥è©¢åƒæ•¸**ï¼š
- `page`: é ç¢¼ï¼ˆé è¨­ 1ï¼‰
- `page_size`: æ¯é ç­†æ•¸ï¼ˆé è¨­ 20ï¼‰
- `status`: ç‹€æ…‹ç¯©é¸ï¼ˆrunning/success/failed/partialï¼‰
- `mode`: æ¨¡å¼ç¯©é¸ï¼ˆtest/productionï¼‰
- `start_date`: é–‹å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
- `end_date`: çµæŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰

---

### 6. æŸ¥è©¢åŸ·è¡Œè©³æƒ…
```
GET http://localhost:8080/api/v1/shoes/execution/{execution_id}
```

**ç¯„ä¾‹**ï¼š
```
GET http://localhost:8080/api/v1/shoes/execution/550e8400-e29b-41d4-a716-446655440000
```

---

### 7. æŸ¥è©¢å•†å“è®Šæ›´æ­·å²
```
GET http://localhost:8080/api/v1/shoes/{product_code}/changes?limit=50
```

**ç¯„ä¾‹**ï¼š
```
GET http://localhost:8080/api/v1/shoes/1103a128-100/changes?limit=50
```

---

### 8. ç²å–çµ±è¨ˆæ•¸æ“š
```
GET http://localhost:8080/api/v1/shoes/execution/statistics?period=last_7_days
```

**æŸ¥è©¢åƒæ•¸**ï¼š
- `period`: çµ±è¨ˆé€±æœŸ
  - `last_24_hours`: æœ€è¿‘ 24 å°æ™‚
  - `last_7_days`: æœ€è¿‘ 7 å¤©ï¼ˆé è¨­ï¼‰
  - `last_30_days`: æœ€è¿‘ 30 å¤©

---

## ğŸ”„ å®Œæ•´ä½¿ç”¨æµç¨‹ç¯„ä¾‹

ä»¥ä¸‹æ˜¯ä¸€å€‹å®Œæ•´çš„çˆ¬èŸ²åŸ·è¡Œæµç¨‹ï¼š

```javascript
// 1. é–‹å§‹åŸ·è¡Œ
const startResponse = await fetch('http://localhost:8080/api/v1/shoes/execution/start', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-API-Key': 'your-api-key'
    },
    body: JSON.stringify({
        total_products: 528,
        mode: 'production'
    })
});

const { data: { execution_id } } = await startResponse.json();

// 2. è™•ç†æ¯å€‹å•†å“ä¸¦è¨˜éŒ„è®Šæ›´
for (const product of products) {
    // æª¢æŸ¥å•†å“ç‹€æ…‹
    const statusResponse = await fetch('http://localhost:8080/api/v1/shoes/check-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-API-Key': 'your-api-key'
        },
        body: JSON.stringify({
            code: product.code
        })
    });
    
    const statusData = await statusResponse.json();
    
    // æ ¹æ“šç‹€æ…‹åŸ·è¡Œç›¸æ‡‰æ“ä½œ
    if (statusData.data.exists) {
        if (statusData.data.needs_update) {
            // æ›´æ–°å•†å“
            await updateProduct(product);
            
            // è¨˜éŒ„æ›´æ–°
            await fetch('http://localhost:8080/api/v1/shoes/execution/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'your-api-key'
                },
                body: JSON.stringify({
                    execution_id,
                    product_code: product.code,
                    action_type: 'update',
                    before_price: statusData.data.current.price,
                    after_price: product.price,
                    change_reason: 'åƒ¹æ ¼æ›´æ–°'
                })
            });
        } else {
            // è¨˜éŒ„ç•¥é
            await fetch('http://localhost:8080/api/v1/shoes/execution/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'your-api-key'
                },
                body: JSON.stringify({
                    execution_id,
                    product_code: product.code,
                    action_type: 'skip',
                    change_reason: 'ç„¡éœ€æ›´æ–°'
                })
            });
        }
    } else {
        // æ–°å¢å•†å“
        await createProduct(product);
        
        // è¨˜éŒ„æ–°å¢
        await fetch('http://localhost:8080/api/v1/shoes/execution/log', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': 'your-api-key'
            },
            body: JSON.stringify({
                execution_id,
                product_code: product.code,
                action_type: 'create',
                after_price: product.price,
                change_reason: 'æ–°å¢å•†å“'
            })
        });
    }
}

// 3. å®ŒæˆåŸ·è¡Œ
await fetch('http://localhost:8080/api/v1/shoes/execution/complete', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-API-Key': 'your-api-key'
    },
    body: JSON.stringify({
        execution_id,
        created_count: 50,
        updated_count: 30,
        skipped_count: 448,
        failed_count: 0,
        status: 'success'
    })
});
```

---

## ğŸ“Š è³‡æ–™åº«çµæ§‹

### execution_history è¡¨
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INT | ä¸»éµ |
| execution_id | VARCHAR(36) | UUID åŸ·è¡Œ ID |
| start_time | DATETIME | é–‹å§‹æ™‚é–“ |
| end_time | DATETIME | çµæŸæ™‚é–“ |
| total_products | INT | ç¸½å•†å“æ•¸ |
| created_count | INT | æ–°å¢æ•¸é‡ |
| updated_count | INT | æ›´æ–°æ•¸é‡ |
| skipped_count | INT | ç•¥éæ•¸é‡ |
| failed_count | INT | å¤±æ•—æ•¸é‡ |
| duration_seconds | DECIMAL(10,2) | åŸ·è¡Œæ™‚é•·ï¼ˆç§’ï¼‰ |
| status | VARCHAR(20) | åŸ·è¡Œç‹€æ…‹ |
| mode | VARCHAR(20) | åŸ·è¡Œæ¨¡å¼ |
| error_message | TEXT | éŒ¯èª¤è¨Šæ¯ |
| created_at | DATETIME | è¨˜éŒ„å‰µå»ºæ™‚é–“ |

### product_change_log è¡¨
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | BIGINT | ä¸»éµ |
| execution_id | VARCHAR(36) | é—œè¯åŸ·è¡Œ ID |
| product_code | VARCHAR(100) | å•†å“ç·¨è™Ÿ |
| product_name | VARCHAR(500) | å•†å“åç¨± |
| action_type | VARCHAR(20) | å‹•ä½œé¡å‹ |
| before_price | VARCHAR(50) | è®Šæ›´å‰åƒ¹æ ¼ |
| after_price | VARCHAR(50) | è®Šæ›´å¾Œåƒ¹æ ¼ |
| before_size | TEXT | è®Šæ›´å‰å°ºå¯¸ |
| after_size | TEXT | è®Šæ›´å¾Œå°ºå¯¸ |
| change_reason | VARCHAR(255) | è®Šæ›´åŸå›  |
| has_price_change | BOOLEAN | åƒ¹æ ¼æ˜¯å¦è®Šå‹• |
| has_size_change | BOOLEAN | å°ºå¯¸æ˜¯å¦è®Šå‹• |
| created_at | DATETIME | è¨˜éŒ„å‰µå»ºæ™‚é–“ |

---

## âš™ï¸ ç³»çµ±æª”æ¡ˆæ¸…å–®

### å¾Œç«¯æª”æ¡ˆ
- **Migration**: `app/Database/Migrations/2026-02-10-000001_CreateExecutionHistoryTables.php`
- **Models**:
  - `app/Models/ExecutionHistoryModel.php`
  - `app/Models/ProductChangeLogModel.php`
- **API Controller**: `app/Controllers/Api/ExecutionController.php`
- **Admin Controller**: `app/Controllers/Admin/ExecutionHistory.php`
- **Routes**: `app/Config/Routes.php`ï¼ˆå·²æ·»åŠ ç›¸é—œè·¯ç”±ï¼‰

### å‰ç«¯è¦–åœ–
- **åˆ—è¡¨é é¢**: `app/Views/admin/execution_history_index.php`
- **è©³æƒ…é é¢**: `app/Views/admin/execution_history_detail.php`

---

## ğŸ¯ æ¸¬è©¦å»ºè­°

1. **æ¸¬è©¦ API ç«¯é»**
   - ä½¿ç”¨ Postman æˆ– curl æ¸¬è©¦å„å€‹ API ç«¯é»
   - ç¢ºèª API Key èªè­‰æ­£å¸¸é‹ä½œ
   - é©—è­‰è«‹æ±‚å’Œå›æ‡‰æ ¼å¼ç¬¦åˆéœ€æ±‚

2. **æ¸¬è©¦å¾Œå°ä»‹é¢**
   - è¨ªå•åŸ·è¡Œæ­·å²åˆ—è¡¨é é¢
   - æ¸¬è©¦ç¯©é¸å’Œåˆ†é åŠŸèƒ½
   - æŸ¥çœ‹åŸ·è¡Œè©³æƒ…é é¢çš„è³‡æ–™é¡¯ç¤º

3. **å®Œæ•´æµç¨‹æ¸¬è©¦**
   - åŸ·è¡Œä¸€æ¬¡å®Œæ•´çš„çˆ¬èŸ²æµç¨‹
   - è¨˜éŒ„å•†å“è®Šæ›´
   - åœ¨å¾Œå°æŸ¥çœ‹è¨˜éŒ„çµæœ

---

## ğŸ“ æ³¨æ„äº‹é …

1. **API Key èªè­‰**ï¼šæ‰€æœ‰ API ç«¯é»éƒ½éœ€è¦æœ‰æ•ˆçš„ API Key
2. **æ™‚é–“æ ¼å¼**ï¼šAPI å›æ‡‰ä½¿ç”¨ ISO 8601 æ ¼å¼ï¼ˆå«æ™‚å€ï¼‰
3. **UUID æ ¼å¼**ï¼šexecution_id ä½¿ç”¨ UUID v4 æ ¼å¼
4. **æ‰¹é‡æ“ä½œ**ï¼šå»ºè­°æ¯æ‰¹ 50-100 ç­†è¨˜éŒ„
5. **éŒ¯èª¤è™•ç†**ï¼šAPI æœƒè¿”å›é©ç•¶çš„éŒ¯èª¤ç¢¼å’Œè¨Šæ¯

---

## ğŸ”— ç›¸é—œé€£çµ

- API æ–‡ä»¶ï¼š[APIåŸ·è¡Œæ­·å²éœ€æ±‚æ–‡ä»¶.md](APIåŸ·è¡Œæ­·å²éœ€æ±‚æ–‡ä»¶.md)
- API Keys ç®¡ç†ï¼šhttp://localhost:8080/admin/api-keys
- API æ—¥èªŒç®¡ç†ï¼šhttp://localhost:8080/admin/api-logs

---

**æœ€å¾Œæ›´æ–°**: 2026-02-10  
**ç‰ˆæœ¬**: 1.0.0
